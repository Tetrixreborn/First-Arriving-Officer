<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>First-Due Drill Sandbox</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet Draw -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

  <style>
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .wrap { display: grid; grid-template-columns: 420px 1fr; height: 100vh; }
    .panel { padding: 12px; border-right: 1px solid #ddd; overflow: auto; }
    #map { height: 100vh; }
    .row { display:flex; gap:8px; margin: 8px 0; }
    input, button, textarea, select { width: 100%; padding: 8px; font-size: 14px; }
    button { cursor: pointer; }
    .card { border: 1px solid #e5e5e5; border-radius: 10px; padding: 10px; margin: 10px 0; }
    .small { font-size: 12px; color: #555; }
    .beats li { margin: 6px 0; }
    .hr { height:1px; background:#eee; margin: 12px 0; }
    .present {
      position: fixed; inset: 0; background: rgba(0,0,0,.85);
      display:none; align-items: center; justify-content: center; padding: 24px;
    }
    .present{
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,.85);
  display: none;
  align-items: center;
  justify-content: center;
  padding: 24px;
  z-index: 99999;
}
    .present .box{
  background:#111;
  color:#fff;
  width: min(1000px, calc(100vw - 48px));
  max-height: calc(100vh - 48px);
  overflow: auto;
  border-radius: 16px;
  padding: 18px;
}
    .present h2 { margin: 0 0 10px; font-size: 28px; }
    .present .prompt { font-size: 22px; line-height: 1.3; }
    .present .reveal { margin-top: 14px; padding: 12px; background: #1f1f1f; border-radius: 12px; display:none; }
    .present .controls { display:flex; gap:10px; margin-top: 14px; }
    .pill { background:#222; padding: 6px 10px; border-radius: 999px; font-size: 12px; display:inline-block; }
  </style>
</head>

<body>
<div class="wrap">
  <div class="panel">
    <h2 style="margin:0 0 6px;">First-Due Drill Sandbox</h2>
    <div class="small">Web-only MVP: address â†’ satellite map â†’ engine/hydrant/entry + hose line + beats + presentation.</div>

    <div class="card">
      <div class="row">
        <input id="scenarioTitle" placeholder="Scenario title (e.g., 14 Oak St - 2-story res)" />
      </div>
      <div class="row">
        <input id="addressInput" placeholder="Search address (e.g., 14 Oak St, YourTown NY)" />
        <button id="btnGeocode" style="width:140px;">Find</button>
      </div>
      <div class="row">
        <button id="btnNew">New</button>
        <button id="btnSave">Save</button>
      </div>
      <div class="row">
        <select id="scenarioSelect"></select>
      </div>
      <div class="row">
        <button id="btnClearMap">Clear map</button>
      </div>
      <div class="row">
        <button id="btnLoad">Load</button>
        <button id="btnDelete">Delete</button>
      </div>
      <div class="row">
        <button id="btnExport">Export JSON</button>
        <input id="importFile" type="file" accept="application/json" />
      </div>
      <div class="small">Tip: use Export as a backup before drill.</div>
    </div>

    <div class="card">
      <div class="small"><b>Map tools</b></div>
      <div class="small">Use the toolbar on the map to add markers/lines. Then edit/move them.</div>
      <div class="hr"></div>
      <div class="row">
      <button id="btnLabelEngine">Label selected: Engine</button>
  <button id="btnLabelTruck">Truck</button>
</div>
<div class="row">
  <button id="btnLabelHydrant">Hydrant</button>
  <button id="btnLabelEntry">Entry</button>
</div>
<div class="row">
  <button id="btnClearLabels">Clear label</button>
</div>
      <div class="row">
        <button id="btnLabelEntry">Entry</button>
        <button id="btnClearLabels">Clear label</button>
      </div>
      <div class="small">Select a marker on the map, then label it.</div>
    </div>

    <div class="card">
      <div class="small"><b>Beats</b> (slide progression)</div>

      <div class="row">
        <input id="beatTitle" placeholder="Beat title (e.g., Dispatch / Arrival / Charlie side)" />
      </div>

      <div class="row">
        <textarea id="beatPrompt" rows="3" placeholder="Prompt (what you ask the crew)"></textarea>
      </div>

      <div class="row">
        <textarea id="beatReveal" rows="2" placeholder="Reveal (your answer / inject)"></textarea>
      </div>

      <div class="row">
        <input id="beatImage" type="file" accept="image/*" />
      </div>

      <div class="row">
        <button id="btnAddBeat">Add beat</button>
        <button id="btnClearBeatForm">Clear</button>
      </div>

      <ol class="beats" id="beatsList"></ol>

      <div class="row">
        <button id="btnPresent">Presentation mode</button>
      </div>
    </div>

  </div>
  <div id="map"></div>
</div>

<div class="present" id="present">
  <div class="box">
    <div class="pill" id="presentMeta"></div>
    <h2 id="presentTitle"></h2>
    <div class="prompt" id="presentPrompt"></div>

    <div id="presentImageWrap" style="margin-top:12px; display:none;">
      <img id="presentImage" style="max-width:100%; border-radius:12px; border:1px solid #333;" />
    </div>

    <div class="reveal" id="presentReveal"></div>

    <div class="controls">
      <button id="pPrev">Prev</button>
      <button id="pNext">Next</button>
      <button id="pToggleReveal">Toggle reveal</button>
      <button id="pClose">Close</button>
    </div>
  </div>
</div>

<script>
  // ---------- Storage ----------
  const STORAGE_KEY = "fd_scenarios_v1";
  function loadAll() {
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
    catch { return []; }
  }
  function saveAll(list) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
  }
  function uuid() { return Math.random().toString(16).slice(2) + Date.now().toString(16); }

  // ---------- Map ----------
  const map = L.map('map', { zoomControl: true }).setView([42.9, -75.0], 12);

  // Satellite tiles (Esri World Imagery)
  L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    maxZoom: 20,
    attribution: 'Tiles Â© Esri'
  }).addTo(map);

  // Drawn features group
  const drawnItems = new L.FeatureGroup();
  map.addLayer(drawnItems);

  // Draw controls
  const drawControl = new L.Control.Draw({
    edit: { featureGroup: drawnItems },
    draw: {
      polygon: false, rectangle: false, circle: false, circlemarker: false,
      marker: true, polyline: true
    }
  });
  map.addControl(drawControl);

  let selectedLayer = null;

  // --- Icon helpers (SVG badge icons) ---
  function svgDataIcon(svg, w = 34, h = 34) {
    const url = "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(svg);
    return L.icon({
      iconUrl: url,
      iconSize: [w, h],
      iconAnchor: [w / 2, h],
      popupAnchor: [0, -h]
    });
  }

  const ICONS = {
    "Engine": svgDataIcon(`
      <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64">
        <circle cx="32" cy="32" r="30" fill="#d32f2f" stroke="#111" stroke-width="4"/>
        <text x="32" y="40" font-size="28" text-anchor="middle" fill="#fff" font-family="Arial" font-weight="700">E</text>
      </svg>
    `),
    "Hydrant": svgDataIcon(`
      <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64">
        <circle cx="32" cy="32" r="30" fill="#1976d2" stroke="#111" stroke-width="4"/>
        <text x="32" y="40" font-size="28" text-anchor="middle" fill="#fff" font-family="Arial" font-weight="700">H</text>
      </svg>
    `),
    "Entry": svgDataIcon(`
      <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64">
        <circle cx="32" cy="32" r="30" fill="#2e7d32" stroke="#111" stroke-width="4"/>
        <text x="32" y="40" font-size="28" text-anchor="middle" fill="#fff" font-family="Arial" font-weight="700">A</text>
      </svg>
    `)
    "Truck": svgDataIcon(`
  <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64">
    <circle cx="32" cy="32" r="30" fill="#6a1b9a" stroke="#111" stroke-width="4"/>
    <text x="32" y="40" font-size="28" text-anchor="middle" fill="#fff" font-family="Arial" font-weight="700">T</text>
  </svg>
`)
  };

  map.on(L.Draw.Event.CREATED, (e) => {
    const layer = e.layer;
    layer.on('click', () => selectLayer(layer));
    drawnItems.addLayer(layer);
  });

  map.on(L.Draw.Event.DELETED, () => { selectedLayer = null; });

  function selectLayer(layer) {
    selectedLayer = layer;
    if (layer instanceof L.Marker) {
      const lbl = layer.options._fdLabel || "Unlabeled";
      layer.bindPopup(`Selected: ${lbl}`).openPopup();
    }
  }

  function setSelectedLabel(label) {
    if (!selectedLayer || !(selectedLayer instanceof L.Marker)) return alert("Select a marker first.");
    selectedLayer.options._fdLabel = label;

    if (ICONS[label]) selectedLayer.setIcon(ICONS[label]);
    else selectedLayer.setIcon(new L.Icon.Default());
  }

  function clearSelectedLabel() {
    if (!selectedLayer || !(selectedLayer instanceof L.Marker)) return alert("Select a marker first.");
    selectedLayer.options._fdLabel = null;
    selectedLayer.setIcon(new L.Icon.Default());
  }

  // Serialize / deserialize drawnItems
  function featuresToGeoJSON() {
    return drawnItems.toGeoJSON();
  }

  function geoJSONToFeatures(geojson) {
    drawnItems.clearLayers();
    selectedLayer = null;
    if (!geojson) return;

    L.geoJSON(geojson, {
      pointToLayer: (feature, latlng) => {
        const m = L.marker(latlng);
        const lbl = feature.properties?._fdLabel || null;

        if (lbl && ICONS[lbl]) {
          m.options._fdLabel = lbl;
          m.setIcon(ICONS[lbl]);
        }

        m.on('click', () => selectLayer(m));
        return m;
      },
      onEachFeature: (feature, layer) => {
        layer.on('click', () => selectLayer(layer));
      }
    }).eachLayer(l => drawnItems.addLayer(l));
  }

  // ---------- Scenario state ----------
  let current = {
    id: uuid(),
    title: "",
    address: "",
    center: map.getCenter(),
    zoom: map.getZoom(),
    geojson: null,
    beats: []
  };

  // ---------- UI helpers ----------
  const scenarioTitle = document.getElementById("scenarioTitle");
  const addressInput = document.getElementById("addressInput");
  const scenarioSelect = document.getElementById("scenarioSelect");
  const beatsList = document.getElementById("beatsList");

  function refreshScenarioSelect() {
    const all = loadAll();
    scenarioSelect.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "Select saved scenarioâ€¦";
    scenarioSelect.appendChild(opt0);

    all.forEach(s => {
      const opt = document.createElement("option");
      opt.value = s.id;
      opt.textContent = s.title || s.address || s.id;
      scenarioSelect.appendChild(opt);
    });
  }

  function escapeHtml(str) {
    return (str ?? "").replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
  }

 function renderBeats() {
  beatsList.innerHTML = "";

  current.beats.forEach((b, idx) => {
    const li = document.createElement("li");
    const hasImg = b.image ? " â€¢ ðŸ“·" : "";

    li.innerHTML = `
      <div><b>${idx+1}. ${escapeHtml(b.title || "Untitled")}${hasImg}</b></div>
      <div class="small">${escapeHtml(b.prompt || "")}</div>
      <div class="row">
        <button data-act="up" data-i="${idx}">Up</button>
        <button data-act="down" data-i="${idx}">Down</button>
        <button data-act="edit" data-i="${idx}">Edit</button>
        <button data-act="del" data-i="${idx}">Delete</button>
      </div>
    `;

    beatsList.appendChild(li);
  });

  beatsList.querySelectorAll("button").forEach(btn => {
    btn.addEventListener("click", () => {
      const i = Number(btn.dataset.i);
      const act = btn.dataset.act;

      if (act === "del") current.beats.splice(i, 1);
      if (act === "up" && i > 0)
        [current.beats[i-1], current.beats[i]] = [current.beats[i], current.beats[i-1]];
      if (act === "down" && i < current.beats.length-1)
        [current.beats[i+1], current.beats[i]] = [current.beats[i], current.beats[i+1]];

      if (act === "edit") {
        document.getElementById("beatTitle").value = current.beats[i].title || "";
        document.getElementById("beatPrompt").value = current.beats[i].prompt || "";
        document.getElementById("beatReveal").value = current.beats[i].reveal || "";
        current.beats.splice(i, 1);
      }

      renderBeats();
    });
  });
}
  function syncFromUI() {
    current.title = scenarioTitle.value.trim();
    current.address = addressInput.value.trim();
    current.center = map.getCenter();
    current.zoom = map.getZoom();

    const gj = featuresToGeoJSON();

    // capture marker labels
    const labeled = [];
    drawnItems.eachLayer(layer => {
      if (layer instanceof L.Marker) {
        const ll = layer.getLatLng();
        labeled.push({ lat: ll.lat, lng: ll.lng, _fdLabel: layer.options._fdLabel || null });
      }
    });

    // inject labels into geojson point features by exact coord match
    gj.features.forEach(f => {
      if (!f.properties) f.properties = {};
      if (f.geometry?.type === "Point") {
        const [lng, lat] = f.geometry.coordinates;
        const match = labeled.find(x => Math.abs(x.lat - lat) < 1e-7 && Math.abs(x.lng - lng) < 1e-7);
        if (match && match._fdLabel) f.properties._fdLabel = match._fdLabel;
      }
    });

    current.geojson = gj;
  }

  function loadIntoUI(s) {
    current = JSON.parse(JSON.stringify(s));
    scenarioTitle.value = current.title || "";
    addressInput.value = current.address || "";
    map.setView([current.center.lat, current.center.lng], current.zoom || 16);
    geoJSONToFeatures(current.geojson);
    renderBeats();
  }

  // ---------- Geocode ----------
  async function geocodeAddress(q) {
    const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q)}`;
    const res = await fetch(url, { headers: { "Accept": "application/json" }});
    if (!res.ok) throw new Error("Geocode failed");
    const data = await res.json();
    if (!data?.length) return null;
    return { lat: Number(data[0].lat), lng: Number(data[0].lon), display: data[0].display_name };
  }

  document.getElementById("btnGeocode").addEventListener("click", async () => {
    const q = addressInput.value.trim();
    if (!q) return;
    try {
      const hit = await geocodeAddress(q);
      if (!hit) return alert("No results.");
      map.setView([hit.lat, hit.lng], 18);
    } catch {
      alert("Geocoding error. Try again.");
    }
  });

  // ---------- Scenario buttons ----------
  document.getElementById("btnNew").addEventListener("click", () => {
    if (!confirm("Start a new scenario? Unsaved changes will be lost.")) return;
    current = { id: uuid(), title:"", address:"", center: map.getCenter(), zoom: map.getZoom(), geojson:null, beats:[] };
    scenarioTitle.value = "";
    addressInput.value = "";
    drawnItems.clearLayers();
    renderBeats();
  });
  document.getElementById("btnClearMap").addEventListener("click", () => {
  if (!confirm("Clear all markers and lines on the map?")) return;
  drawnItems.clearLayers();
  selectedLayer = null;
});
  

  document.getElementById("btnSave").addEventListener("click", () => {
    syncFromUI();
    const all = loadAll();
    const idx = all.findIndex(x => x.id === current.id);
    if (idx >= 0) all[idx] = current; else all.push(current);
    saveAll(all);
    refreshScenarioSelect();
    alert("Saved.");
  });

  document.getElementById("btnLoad").addEventListener("click", () => {
    const id = scenarioSelect.value;
    if (!id) return;
    const s = loadAll().find(x => x.id === id);
    if (!s) return alert("Not found.");
    loadIntoUI(s);
  });

  document.getElementById("btnDelete").addEventListener("click", () => {
    const id = scenarioSelect.value;
    if (!id) return;
    if (!confirm("Delete this saved scenario?")) return;
    saveAll(loadAll().filter(x => x.id !== id));
    refreshScenarioSelect();
  });

  document.getElementById("btnExport").addEventListener("click", () => {
    syncFromUI();
    const blob = new Blob([JSON.stringify(current, null, 2)], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = (current.title || "scenario").replace(/[^a-z0-9]+/gi,"_").toLowerCase() + ".json";
    a.click();
  });

  document.getElementById("importFile").addEventListener("change", async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    const text = await file.text();
    try {
      const s = JSON.parse(text);
      if (!s.id) s.id = uuid();
      loadIntoUI(s);
      alert("Imported. Click Save to store it.");
    } catch {
      alert("Invalid JSON file.");
    }
  });

  // ---------- Label buttons ----------
  document.getElementById("btnLabelEngine").addEventListener("click", () => setSelectedLabel("Engine"));
  document.getElementById("btnLabelHydrant").addEventListener("click", () => setSelectedLabel("Hydrant"));
  document.getElementById("btnLabelEntry").addEventListener("click", () => setSelectedLabel("Entry"));
  document.getElementById("btnClearLabels").addEventListener("click", () => clearSelectedLabel());
  document.getElementById("btnLabelTruck").addEventListener("click", () => setSelectedLabel("Truck"));

  // ---------- Beat image upload (minimal) ----------
  let beatImageDataUrl = null;

  document.getElementById("beatImage").addEventListener("change", (e) => {
    const file = e.target.files?.[0];
    if (!file) { beatImageDataUrl = null; return; }

    const reader = new FileReader();
    reader.onload = () => { beatImageDataUrl = reader.result; };
    reader.readAsDataURL(file);
  });

  // ---------- Beats ----------
  document.getElementById("btnAddBeat").addEventListener("click", () => {
    const t = document.getElementById("beatTitle").value.trim();
    const p = document.getElementById("beatPrompt").value.trim();
    const r = document.getElementById("beatReveal").value.trim();

    current.beats.push({ title: t, prompt: p, reveal: r, image: beatImageDataUrl });

    document.getElementById("beatTitle").value = "";
    document.getElementById("beatPrompt").value = "";
    document.getElementById("beatReveal").value = "";
    beatImageDataUrl = null;
    document.getElementById("beatImage").value = "";

    renderBeats();
  });

  document.getElementById("btnClearBeatForm").addEventListener("click", () => {
    document.getElementById("beatTitle").value = "";
    document.getElementById("beatPrompt").value = "";
    document.getElementById("beatReveal").value = "";
    beatImageDataUrl = null;
    document.getElementById("beatImage").value = "";
  });

  // ---------- Presentation ----------
  const present = document.getElementById("present");
  const presentMeta = document.getElementById("presentMeta");
  const presentTitle = document.getElementById("presentTitle");
  const presentPrompt = document.getElementById("presentPrompt");
  const presentReveal = document.getElementById("presentReveal");
  const presentImageWrap = document.getElementById("presentImageWrap");
  const presentImage = document.getElementById("presentImage");

  let pIndex = 0;
  let pRevealOn = false;

  function renderPresent() {
    const beats = current.beats || [];
    if (!beats.length) {
      presentTitle.textContent = current.title || "No beats yet";
      presentPrompt.textContent = "Add beats in the editor first.";
      presentReveal.style.display = "none";
      presentMeta.textContent = "0 / 0";
      presentImageWrap.style.display = "none";
      return;
    }

    const b = beats[pIndex];
    presentMeta.textContent = `${pIndex+1} / ${beats.length} â€¢ ${current.title || current.address || "Scenario"}`;
    presentTitle.textContent = b.title || `Beat ${pIndex+1}`;
    presentPrompt.textContent = b.prompt || "";
    presentReveal.textContent = b.reveal || "";

    if (b.image) {
      presentImage.src = b.image;
      presentImageWrap.style.display = "block";
    } else {
      presentImageWrap.style.display = "none";
    }

    presentReveal.style.display = (pRevealOn && b.reveal) ? "block" : "none";
  }

  document.getElementById("btnPresent").addEventListener("click", () => {
    syncFromUI();
    pIndex = 0;
    pRevealOn = false;
    renderPresent();
    present.style.display = "flex";
  });

  document.getElementById("pPrev").addEventListener("click", () => {
    pIndex = Math.max(0, pIndex - 1);
    pRevealOn = false;
    renderPresent();
  });

  document.getElementById("pNext").addEventListener("click", () => {
    pIndex = Math.min((current.beats?.length || 1) - 1, pIndex + 1);
    pRevealOn = false;
    renderPresent();
  });

  document.getElementById("pToggleReveal").addEventListener("click", () => {
    pRevealOn = !pRevealOn;
    renderPresent();
  });

  document.getElementById("pClose").addEventListener("click", () => {
    present.style.display = "none";
  });

  // Init
  refreshScenarioSelect();
  renderBeats();
</script>
</body>
</html>
